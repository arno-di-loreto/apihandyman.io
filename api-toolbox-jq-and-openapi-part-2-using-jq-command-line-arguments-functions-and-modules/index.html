<!DOCTYPE html>
<html lang="en">

  


<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  
  <link rel="apple-touch-icon" href="/images/favicons/favicon.png">
  <link rel="shortcut icon" href="/images/favicons/favicon.ico" type="image/x-icon">
  <link rel="icon" type="image/png" href="/images/favicons/favicon.png">

  <title>API Toolbox - JQ and OpenAPI - Part 2 - Using JQ command line arguments, functions and modules | API Handyman</title>
  <meta name="description" content="Ever wanted to quickly find, extract or modify data coming from some JSON documents on the command line? JQ is the tool you‚Äôre looking for. In the previous p...">
  

<meta name="twitter:card" content="summary">
<meta name="twitter:site" content="@apihandyman">

  <meta name="twitter:title" content="API Toolbox - JQ and OpenAPI - Part 2 - Using JQ command line arguments, functions and modules">


  <meta name="twitter:url" content="https://apihandyman.io/api-toolbox-jq-and-openapi-part-2-using-jq-command-line-arguments-functions-and-modules/">


  <meta name="twitter:description" content="Ever wanted to quickly find, extract or modify data coming from some JSON documents on the command line? JQ is the tool you‚Äôre looking for. In the previous part of this JQ and OpenAPI Series, we learned to invoke JQ and how to extract data from JSON documents using some of its many filters. Now we will discover how to build flexible and easily reusable JQ filters by creating functions and modules and also using command line arguments.">

  <meta name="twitter:image:src" content="https://apihandyman.io/images/api-toolbox-jq-and-openapi-part-2-using-jq-command-line-arguments-functions-and-modules/thumbnail.png">

  



  <meta name="og:description" content="Ever wanted to quickly find, extract or modify data coming from some JSON documents on the command line? JQ is the tool you‚Äôre looking for. In the previous part of this JQ and OpenAPI Series, we learned to invoke JQ and how to extract data from JSON documents using some of its many filters. Now we will discover how to build flexible and easily reusable JQ filters by creating functions and modules and also using command line arguments.">

<meta name="og:image" content="https://apihandyman.io/images/api-toolbox-jq-and-openapi-part-2-using-jq-command-line-arguments-functions-and-modules/thumbnail.png">

  <link rel="stylesheet" href="/css/bootstrap.min.css">
  <link rel="stylesheet" href="/css/prism.css">
  <link rel="stylesheet" href="/css/main.css">
  <link rel="stylesheet" type="text/css" href="/css/asciinema-player.css" />
  <script defer src="https://use.fontawesome.com/releases/v5.0.8/js/all.js"></script>  <link rel="canonical" href="/api-toolbox-jq-and-openapi-part-2-using-jq-command-line-arguments-functions-and-modules/">
  <link rel="stylesheet" href="/css/bootstrap-toc.min.css">
  <link rel="alternate" type="application/rss+xml" title="API Handyman" href="/feed.xml">
  
  <script type="text/javascript" src="/js/fingerprint2.min.js" ></script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  new Fingerprint2().get(function(clientId) {
    ga('create', 'UA-58046291-1', {
      'storage': 'none',
      'clientId':clientId,
      'storeGac': false
    });
    ga('set', 'anonymizeIp', true);
    ga('send', 'pageview');
  });

</script>
  

  
</head>

  <body>
      <div class="container">
        <div class="row">
          <div class="col-xs-12 col-md-12">
            <!--<header>-->
  <!-- Static navbar -->
  <nav class="navbar navbar-fixed-top full">
    <div class="container-fluid">
      <div class="navbar-header">
        <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
          <span class="sr-only">Toggle navigation</span>
          <i class="fa fa-bars fa-2x" aria-hidden="true"></i>
        </button>
        <a class="navbar-brand" href="/">API Handyman</a>
      </div>
      <div id="navbar" class="navbar-collapse collapse">
        <ul class="nav navbar-nav navbar-right">
          
          
            <li class="dropdown">
              <a href="#" class="page-link dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">Series: API Toolbox - JQ and OpenAPI<span class="caret"></span></a>
              <ul class="dropdown-menu">
                
                    <li ><a class="page-link" href="/api-toolbox-jq-and-openapi-part-1-using-jq-to-extract-data-from-openapi-files/">Part 1 - Using JQ to extract data from OpenAPI files</a></li>
                
                    <li  class="disabled" ><a class="page-link" href="/api-toolbox-jq-and-openapi-part-2-using-jq-command-line-arguments-functions-and-modules/">Part 2 - Using JQ command line arguments, functions and modules</a></li>
                
              </ul>
            </li>
          
          <li class="nav-item nav-dea"><a class="page-link" href="http://bit.ly/designwebapis">My Book: The Design Of Web APIs</a></li>
          <li class="nav-item nav-asb"><a class="page-link" href="http://apistylebook.com/">API Stylebook</a></li>
          <li class="dropdown">
              <a href="#" class="page-link dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">OpenAPI<span class="caret"></span></a>
            <ul class="dropdown-menu">
              <li class="nav-item nav-oas"><a class="page-link" href="/openapi/">What is the OpenAPI Specification</a></li>
              <li class="nav-item nav-oas"><a class="page-link" href="/explore-the-openapi-specification-3.0-with-the-openapi-map/">OpenAPI Map</a></li>
              <li class="nav-item nav-oas"><a class="page-link" href="/writing-openapi-swagger-specification-tutorial-part-1-introduction/">OpenAPI 2.0 Tutorial</a></li>
            </ul>
          </li>
          <li class="dropdown">
              <a href="#" class="page-link dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">Blog<span class="caret"></span></a>
            <ul class="dropdown-menu">
              
              <li class="nav-item"><a class="page-link" href="/categories/posts">Posts</a></li>
              
              <li class="nav-item"><a class="page-link" href="/categories/talks">Talks</a></li>
              
              <li class="nav-item"><a class="page-link" href="/categories/elsewhere">Elsewhere</a></li>
              
            </ul>
          </li>
          <li class="nav-item"><a class="page-link" href="/about/">About</a></li>
        </ul>
      </div><!--/.nav-collapse -->
    </div><!--/.container-fluid -->
  </nav>
<!--</header>-->
          </div>
        </div>
      </div>
      





<header>
  <!--<div class="container main-container full-jumbotron">-->
      <div class="jumbotron" style="background-image: url('/images/api-toolbox-jq-and-openapi-part-2-using-jq-command-line-arguments-functions-and-modules/thumbnail.png')">
        <div class="header-caption text-center">
          <h1 class="post-title" itemprop="name headline">Part 2 - Using JQ command line arguments, functions and modules</h1>
          
            <h2 class="post-subtitle">API Toolbox - JQ and OpenAPI</h2>
          
        </div>
      </div>
  <!--</div>-->
</header>
      <div class="container main-container">
        <div class = "row">
          <main>
          <div class="hidden-xs hidden-sm col-md-2" role="complementary">
  <nav id="left-banner" data-spy="affix" data-offset-top="400">   
    <div class="book-banner-vertical">
    <p class="book-banner-vertical-top"><a href="http://bit.ly/designwebapis">Read my book</a></p>
    <a href="http://bit.ly/designwebapis"><img class="img-responsive center-block " src="/images/commons/book/book-vertical.png"></a>
    <p class="book-banner-vertical-bottom">(affiliate link, use fcclauret discount code to get 37% off)</p>
</div>
  </nav>
</div>
<div class="col-xs-12 col-sm-9 col-md-8" role="main">
  <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
    <div class="row">
  <div class="col-xs-12 col-sm-12 hidden-md hidden-lg">
      <div class="post-summary book-banner-horizontal">
    <p><a class="post-link" href="http://bit.ly/designwebapis">Read my book (affiliate link, use fcclauret discount code to get 37% off)</a></p>
    <a class="post-link" href="http://bit.ly/designwebapis">
      <img class="img-responsive center-block post-summary-thumbnail" src="/images/commons/book/book-horizontal.png"></a>
  </div>
  </div>
</div>
    <div id="post" class="blog-container" itemprop="articleBody">
      <p class="post-meta">
        
          By
          <span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">Arnaud Lauret</span></span>
        
        
        &nbsp;&nbsp;|&nbsp;<time datetime="2020-02-03T00:00:00+00:00" itemprop="datePublished">Feb. 3, 2020</time><span>&nbsp;|&nbsp;Posts</span>
      </p>
      <p>Ever wanted to quickly find, extract or modify data coming from some JSON documents on the command line? JQ is the tool you‚Äôre looking for. In the previous part of this JQ and OpenAPI Series, we learned to invoke JQ and how to extract data from JSON documents using some of its many filters. Now we will discover how to build flexible and easily reusable JQ filters by creating functions and modules and also using command line arguments.<!--more--> We will continue working on OpenAPI files, at the end of this second part, we‚Äôll have built a multi-criteria OpenAPI search and some reusable filters, especially one that you‚Äôll be able to reuse anytime you‚Äôll have to deal with JQ command line parameters.</p>

<h1 id="jq-and-openapi-post-series">JQ and OpenAPI post series</h1>

<p><a href="https://stedolan.github.io/jq/manual/v1.6/" target="jq">JQ‚Äôs documentation</a> is quite complete and there are many tutorials and Stackoverflow answers, so why bother writing this series? First reason, I regularly meet people working with APIs and/or JSON files who actually don‚Äôt know JQ exists and how it could save their life (or at least their time). Second reason, I often use it with OpenAPI specification files and I found that showing how JQ can be used on such a widely adopted and familiar JSON based format could help to learn how to use it (and also writing this post actually helped me to improve my JQ skills!).</p>

<p>This JQ and OpenAPI series is composed of the following posts:</p>

<ul>
  
    
    <li><a class="page-link" href="/api-toolbox-jq-and-openapi-part-1-using-jq-to-extract-data-from-openapi-files/">Part 1 - Using JQ to extract data from OpenAPI files</a></li>
    
  
    
    <li><strong>Part 2 - Using JQ command line arguments, functions and modules</strong></li>
    
  
  <li>Part 3 - Modifying OpenAPI files with JQ (coming soon)</li>
  <li>Part 4 - Bonus: coloring JQ's raw output (coming soon)</li>
</ul>

<h1 id="get-posts-content">Get post‚Äôs content</h1>

<p>All examples shown in this post are based on JQ 1.6 and OpenAPI 3. All examples can be copied using the <i class="fas fa-paste"></i> button and downloaded using the <i class="fas fa-file-code"></i> one on code snippets. All source code can be retrieved from the <a href="https://github.com/arno-di-loreto/jq-and-openapi/" target="jq">JQ and OpenAPI post series‚Äô github repository</a>.</p>

<div>
  <pre class="copy-hidden">git clone https://github.com/arno-di-loreto/jq-and-openapi/
cd jq-and-openapi
git checkout part-2

</pre>
  
  <div class="code-toolbar">
    <div class="btn-group" role="group" aria-label="...">
      
      <button type="button" class="btn btn-default copy-btn"><i class="fas fa-paste"></i></button>
    </div>
  </div>
  <pre class="language-bash line-numbers"><code>[apihandyman.io]$ git clone https://github.com/arno-di-loreto/jq-and-openapi/
[apihandyman.io]$ cd jq-and-openapi
[apihandyman.io]$ git checkout part-2</code></pre>
  
</div>

<h1 id="listing-operations-using-functions-and-modules">Listing operations using functions and modules</h1>

<p>In previous post, we built a filter that lists the operations available in an OpenAPI file. In this first section, we will just refactor the JQ code to make it more readable and reusable using functions and modules. The following listing shows what happens when using the new version of list-operations.jq on the demo OpenAPI file.</p>

<div>
  <pre class="copy-hidden">jq -r -f list-operations.jq demo-api-openapi.json

</pre>
  <div class="code-title"><button type="button" class="btn btn-default btn-block">Same result as in part 1 but list-operations.jq has changed under the hood</button></div>
  <div class="code-toolbar-for-title">
    <div class="btn-group" role="group" aria-label="...">
      
      <button type="button" class="btn btn-default copy-btn"><i class="fas fa-paste"></i></button>
    </div>
  </div>
  <pre class="language-bash line-numbers"><code>[apihandyman.io]$ jq -r -f list-operations.jq demo-api-openapi.json
get     /accounts       List accounts
get     /accounts/{id}  Get an account
post    /beneficiaries  Register a beneficiary
get     /beneficiaries  List beneficiaries
delete  /beneficiaries/{id}     Delete a beneficiary (deprecated)
patch   /beneficiaries/{id}     Updates a beneficiary (deprecated)
get     /beneficiaries/{id}     Get a beneficiary
get     /sources        List transfer sources
get     /sources/{id}/destinations      List transfer source&#39;s destinations
post    /transfers      Transfer money
get     /transfers      List money transfers
get     /transfers/{id} Get a money transfer
patch   /transfers/{id}
delete  /transfers/{id} Cancel a money transfer</code></pre>
  
</div>

<p>It seems nothing has changed, it still outputs operations HTTP methods, paths and summaries, but under the hood, the JQ file used has changed as shown in the following listing.</p>

<div>
  <!-- codeblocksize: 20 -->
  <div class="code-title"><button type="button" class="btn btn-default btn-block">list-operations.jq</button></div>
  <div class="code-toolbar-for-title">
    <div class="btn-group" role="group" aria-label="...">
        
        <button type="button" class="btn btn-default"><a target="_blank" href="/code/api-toolbox-jq-and-openapi/part-2/list-operations.jq"><i class="fas fa-file-code"></i></a></button>
        <button type="button" class="btn btn-default btn-copy"><i class="fas fa-paste"></i></button>
    </div>
  </div>
  <pre class="language-jq line-numbers"><code>include "module-openapi"; # Imports module-openapi.jq file

oas_operations | # Function coming from module-openapi.jq file
oas_operations_to_text  # Function coming from module-openapi.jq file</code></pre>
  
</div>

<p>Let‚Äôs see how it was created, we‚Äôll discover functions and then modules.</p>

<h2 id="creating-functions">Creating functions</h2>

<p>As a reminder, here‚Äô the previous version of the <code>list-operations.jq</code> file we created in previous part. It is composed of three steps. Steps 1 and 2 build an array of operation object containing a (HTTP) method, path, summary and deprecated indicator. Step 3 aims to print this array as tab separated text.</p>

<div>
  <!-- codeblocksize: 20 -->
  <div class="code-title"><button type="button" class="btn btn-default btn-block">list-operations-original.jq</button></div>
  <div class="code-toolbar-for-title">
    <div class="btn-group" role="group" aria-label="...">
        <button type="button" class="btn btn-default" onclick="toggle(this, this.parentElement.parentElement.parentElement.children[2], this.parentElement.parentElement.parentElement.children[3].children[0])"><i class="fa fa-expand" aria-hidden="true"></i></button>
        <button type="button" class="btn btn-default"><a target="_blank" href="/code/api-toolbox-jq-and-openapi/part-2/list-operations-original.jq"><i class="fas fa-file-code"></i></a></button>
        <button type="button" class="btn btn-default btn-copy"><i class="fas fa-paste"></i></button>
    </div>
  </div>
  <pre class="language-jq line-numbers code-collapsed"><code># 1 - Selects paths objects
#--------------------------
# returns [{key: path, value: path value}]
.paths # Selects the paths property content
| to_entries # Transforms
             # { "/resources": { "get": {operation data}}} 
             # to 
             # [ { "key": "/resources", 
             #     "value": { "get": {operation data}} ]
| map(select(.key | test("^x-") | not)) # Gets rid of x-tensions
# 2 - Creates an array of operations
#-----------------------------------
# returns [{path, method, summary, deprecated}]
| map ( # Applies a transformation to each element
  .key as $path # Stores the path value (.key) 
                  # in a variable ($path) for later use
  | .value # Keeps only the path's content 
           # { "get": {operation data}}
  | to_entries # Transforms 
               # { "get": {operation data}}
               # to
               # [ { "key": "get", 
               #     "value": {operation data}} ]
  | map( # Applies a transformation to each element
    select( # Keeps only elements for which the following is true
      # With IN, which returns true if the value is one of its
      # parameters, we can get rid of x- , parameters
      # description and summary properties
      .key | IN("get", "put", "post", "delete", 
         "options", "head", "patch", "trace")
    )
    | # Creates a new JSON object
    {
      method: .key,
      path: $path, # Using the variable defined on line 4
      summary: .value.summary?,
      deprecated: .value.deprecated?
    }
  )[] # Flattens array to avoid having an array 
      # of array of {path, method, summary, deprecated}
) # Now we have an array of {path, method, summary, deprecated}
# 3 - Outputs tab separated raw text
#-----------------------------------
| map( # Applies a transformation to each element
  .method + "\t" + 
  .path + "\t" + 
  .summary + 
  (if .deprecated then " (deprecated)" else "" end)
)
[] # Flattens array for raw output</code></pre>
  <div class="code-bottom-toolbar"><button type="button" class="btn btn-default btn-block" onclick="toggle(this, this.parentElement.parentElement.children[2], this.parentElement.parentElement.children[1].children[0].children[0], true)"><i class="fa fa-expand" aria-hidden="true"></i></button></div>
</div>

<p>Let‚Äôs focus on step 3, which is shown below, and build a function that does the same job.</p>

<div>
  <!-- codeblocksize: 20 -->
  <div class="code-title"><button type="button" class="btn btn-default btn-block">We will create a function for step 3</button></div>
  <div class="code-toolbar-for-title">
    <div class="btn-group" role="group" aria-label="...">
        
        <button type="button" class="btn btn-default"><a target="_blank" href="/code/api-toolbox-jq-and-openapi/part-2/list-operations-original.jq"><i class="fas fa-file-code"></i></a></button>
        <button type="button" class="btn btn-default btn-copy"><i class="fas fa-paste"></i></button>
    </div>
  </div>
  <pre class="language-jq line-numbers" data-start="42"><code># 3 - Outputs tab separated raw text
#-----------------------------------
| map( # Applies a transformation to each element
  .method + "\t" + 
  .path + "\t" + 
  .summary + 
  (if .deprecated then " (deprecated)" else "" end)
)
[] # Flattens array for raw output</code></pre>
  
</div>

<p>Defining a function in JQ is quite simple: at the beginning of the file, add a <code>def function_name:</code> put some filters and end by <code>;</code> and you‚Äôre done. The <code>oas_operation_to_text</code> which basically contains step 3‚Äôs filters is shown below.</p>

<div>
  <!-- codeblocksize: 20 -->
  <div class="code-title"><button type="button" class="btn btn-default btn-block">Defining the oas_operation_to_text function</button></div>
  <div class="code-toolbar-for-title">
    <div class="btn-group" role="group" aria-label="...">
        
        <button type="button" class="btn btn-default"><a target="_blank" href="/code/api-toolbox-jq-and-openapi/part-2/list-operations-with-to-text-function.jq"><i class="fas fa-file-code"></i></a></button>
        <button type="button" class="btn btn-default btn-copy"><i class="fas fa-paste"></i></button>
    </div>
  </div>
  <pre class="language-jq line-numbers"><code>def oas_operations_to_text: # Defining a function that
                            # Prints operations as raw text
  map( # Applies a transformation to each element
    .method + "\t" + 
    .path + "\t" + 
    .summary + 
    (if .deprecated then " (deprecated)" else "" end)
  )
  [] # Flattens array for raw output
; # oas_operations_to_text function's end
</code></pre>
  
</div>

<p>If defining a function in JQ is quite simple, using it is even more simple. Just call it like any regular JQ filter. The following listing shows how step 3‚Äôs code has been replaced by the new <code>oas_operation_to_text</code> custom filter which is on top of the file.</p>

<div>
  <!-- codeblocksize: 20 -->
  <div class="code-title"><button type="button" class="btn btn-default btn-block">Using the oas_operation_to_text function</button></div>
  <div class="code-toolbar-for-title">
    <div class="btn-group" role="group" aria-label="...">
        
        <button type="button" class="btn btn-default"><a target="_blank" href="/code/api-toolbox-jq-and-openapi/part-2/list-operations-with-to-text-function.jq"><i class="fas fa-file-code"></i></a></button>
        <button type="button" class="btn btn-default btn-copy"><i class="fas fa-paste"></i></button>
    </div>
  </div>
  <pre class="language-jq line-numbers" data-start="53"><code># 3 - Outputs tab separated raw text
#-----------------------------------
| oas_operations_to_text</code></pre>
  
</div>

<p>Here‚Äôs the full modified list-operations.jq file including the <code>oas_operation_to_text</code> definition at the beginning and its calling on the last line.</p>

<div>
  <!-- codeblocksize: 20 -->
  <div class="code-title"><button type="button" class="btn btn-default btn-block">list-operations-with-to-text-function.jq</button></div>
  <div class="code-toolbar-for-title">
    <div class="btn-group" role="group" aria-label="...">
        <button type="button" class="btn btn-default" onclick="toggle(this, this.parentElement.parentElement.parentElement.children[2], this.parentElement.parentElement.parentElement.children[3].children[0])"><i class="fa fa-expand" aria-hidden="true"></i></button>
        <button type="button" class="btn btn-default"><a target="_blank" href="/code/api-toolbox-jq-and-openapi/part-2/list-operations-with-to-text-function.jq"><i class="fas fa-file-code"></i></a></button>
        <button type="button" class="btn btn-default btn-copy"><i class="fas fa-paste"></i></button>
    </div>
  </div>
  <pre class="language-jq line-numbers code-collapsed" data-line="1-10,55"><code>def oas_operations_to_text: # Defining a function that
                            # Prints operations as raw text
  map( # Applies a transformation to each element
    .method + "\t" + 
    .path + "\t" + 
    .summary + 
    (if .deprecated then " (deprecated)" else "" end)
  )
  [] # Flattens array for raw output
; # oas_operations_to_text function's end

# 1 - Selects paths objects
#--------------------------
# returns [{key: path, value: path value}]
.paths # Selects the paths property content
| to_entries # Transforms
             # { "/resources": { "get": {operation data}}} 
             # to 
             # [ { "key": "/resources", 
             #     "value": { "get": {operation data}} ]
| map(select(.key | test("^x-") | not)) # Gets rid of x-tensions
# 2 - Creates an array of operations
#-----------------------------------
# returns [{path, method, summary, deprecated}]
| map ( # Applies a transformation to each element
  .key as $path # Stores the path value (.key) 
                  # in a variable ($path) for later use
  | .value # Keeps only the path's content 
           # { "get": {operation data}}
  | to_entries # Transforms 
               # { "get": {operation data}}
               # to
               # [ { "key": "get", 
               #     "value": {operation data}} ]
  | map( # Applies a transformation to each element
    select( # Keeps only elements for which the following is true
      # With IN, which returns true if the value is one of its
      # parameters, we can get rid of x- , parameters
      # description and summary properties
      .key | IN("get", "put", "post", "delete", 
         "options", "head", "patch", "trace")
    )
    | # Creates a new JSON object
    {
      method: .key,
      path: $path, # Using the variable defined on line 4
      summary: .value.summary?,
      deprecated: .value.deprecated?
    }
  )[] # Flattens array to avoid having an array 
      # of array of {path, method, summary, deprecated}
) # Now we have an array of {path, method, summary, deprecated}
# 3 - Outputs tab separated raw text
#-----------------------------------
| oas_operations_to_text</code></pre>
  <div class="code-bottom-toolbar"><button type="button" class="btn btn-default btn-block" onclick="toggle(this, this.parentElement.parentElement.children[2], this.parentElement.parentElement.children[1].children[0].children[0], true)"><i class="fa fa-expand" aria-hidden="true"></i></button></div>
</div>

<p>That‚Äôs great, using functions big JQ filters are far more readable. But what about being able to reuse these functions?</p>

<h2 id="creating-a-module-with-reusable-functions">Creating a module with reusable functions</h2>

<p>Creating JQ <em>modules</em> that define reusable functions is, again, quite simple. Just put some functions in a JQ file and you‚Äôre done. The following listing shows a <code>module-openapi.jq</code> module file defining two functions. There‚Äôs the <code>oas_operation_to_text</code> we have just created and also an <code>oas_operations</code> which do the same as steps 1 and 2 of the <code>list-operations.jq</code> file (returning an array of operations). Note that there‚Äôs a light modification (line 43/44), this function returns also the <code>input_filename</code> and the original value of each operations (for a later use) besides its HTTP method, path, summary and deprecated flag.</p>

<div>
  <!-- codeblocksize: 20 -->
  <div class="code-title"><button type="button" class="btn btn-default btn-block">module-openapi.jq</button></div>
  <div class="code-toolbar-for-title">
    <div class="btn-group" role="group" aria-label="...">
        <button type="button" class="btn btn-default" onclick="toggle(this, this.parentElement.parentElement.parentElement.children[2], this.parentElement.parentElement.parentElement.children[3].children[0])"><i class="fa fa-expand" aria-hidden="true"></i></button>
        <button type="button" class="btn btn-default"><a target="_blank" href="/code/api-toolbox-jq-and-openapi/part-2/module-openapi.jq"><i class="fas fa-file-code"></i></a></button>
        <button type="button" class="btn btn-default btn-copy"><i class="fas fa-paste"></i></button>
    </div>
  </div>
  <pre class="language-jq line-numbers code-collapsed"><code># This is a reusable JQ module defining useful
# OpenAPI specification (OAS) processing functions

def oas_operations: # Defining a listoperations function
                    # returning {path, method, summary, original}
  # 1 - Selects paths objects
  #--------------------------
  # returns [{key: path, value: path value}]
  .paths # Selects the paths property content
  | to_entries # Transforms
              # { "/resources": { "get": {operation data}}} 
              # to 
              # [ { "key": "/resources", 
              #     "value": { "get": {operation data}} ]
  | map(select(.key | test("^x-") | not)) # Gets rid of x-tensions
  # 2 - Creates an array of operations
  #-----------------------------------
  # returns [{path, method, summary, deprecated}]
  | map ( # Applies a transformation to each element
    .key as $path # Stores the path value (.key) 
                    # in a variable ($path) for later use
    | .value # Keeps only the path's content 
            # { "get": {operation data}}
    | to_entries # Transforms 
                # { "get": {operation data}}
                # to
                # [ { "key": "get", 
                #     "value": {operation data}} ]
    | map( # Applies a transformation to each element
      select( # Keeps only elements for which the following is true
        # With IN, which returns true if the value is one of its
        # parameters, we can get rid of x- , parameters
        # description and summary properties
        .key | IN("get", "put", "post", "delete", 
          "options", "head", "patch", "trace")
      )
      | # Creates a new JSON object
      {
        method: .key,
        path: $path, # Using the variable defined on line 4
        summary: .value.summary?,
        deprecated: .value.deprecated?,
        original: .value, # Keeping original value, just in case üòâ
        source: input_filename # Adding source file, also just in case üòâ
      }
    )[] # Flattens array to avoid having an array 
        # of array of {path, method, summary, deprecated}
  ) # Now we have an array of {path, method, summary, deprecated}
; # oas_operations function's end

def oas_operations_to_text: # Defining a function that
                            # Prints operations as raw text
  map( # Applies a transformation to each element
    .method + "\t" + 
    .path + "\t" + 
    .summary + 
    (if .deprecated then " (deprecated)" else "" end)
  )
  [] # Flattens array for raw output
; # oas_operations_to_text function's end</code></pre>
  <div class="code-bottom-toolbar"><button type="button" class="btn btn-default btn-block" onclick="toggle(this, this.parentElement.parentElement.children[2], this.parentElement.parentElement.children[1].children[0].children[0], true)"><i class="fa fa-expand" aria-hidden="true"></i></button></div>
</div>

<p>Let‚Äôs get back to the new version of <code>list-operations.jq</code> (shown below) to see how this module is actually used. The module is include with the <code>include &lt;module name without extension&gt;;</code> line. Then any functions defined in it can be used like any other regular JQ filter as shown on line 3 and 4 where <code>oas_operations</code> and <code>oas_operations_to_text</code> are used.</p>

<div>
  <!-- codeblocksize: 20 -->
  <div class="code-title"><button type="button" class="btn btn-default btn-block">list-operations.jq</button></div>
  <div class="code-toolbar-for-title">
    <div class="btn-group" role="group" aria-label="...">
        
        <button type="button" class="btn btn-default"><a target="_blank" href="/code/api-toolbox-jq-and-openapi/part-2/list-operations.jq"><i class="fas fa-file-code"></i></a></button>
        <button type="button" class="btn btn-default btn-copy"><i class="fas fa-paste"></i></button>
    </div>
  </div>
  <pre class="language-jq line-numbers"><code>include "module-openapi"; # Imports module-openapi.jq file

oas_operations | # Function coming from module-openapi.jq file
oas_operations_to_text  # Function coming from module-openapi.jq file</code></pre>
  
</div>

<h2 id="managing-modules-locations">Managing modules locations</h2>

<asciinema-player poster="npt:1:20" title="Managing JQ modules location" author="Arnaud Lauret" rows="24" cols="80" src="/code/api-toolbox-jq-and-openapi/part-2/module-location.cast"></asciinema-player>

<p>The following listings shows different ways of managing reusable modules location with JQ (see <a href="https://stedolan.github.io/jq/manual/#Modules">modules</a> in the JQ‚Äôs documentation for a complete description of what can be done).
It starts by a a first command done inside the <code>jq-and-openapi</code> folder.
It simply returns the first operation‚Äôs summary of the <code>demo-api-openapi.json</code> file using the <code>oas_operations[0]</code> filter composed of the <code>oas_operations</code> function and the <code>[]</code> array filter.
As you can see, there‚Äôs no need to create a JQ file to use a module, just use the <code>include</code> directive in the <code>'&lt;filter&gt;'</code> argument on the command line.
Then we go a level up, and obviously redoing the same exact command does not work anymore: the <code>module-openapi.jq</code> cannot be found in the current folder as it is in the <code>jq-and-openapi</code> one.
Hopefully, you can use the <code>-L &lt;path list&gt;</code> argument to tell JQ where to look for modules.</p>

<div>
  <pre class="copy-hidden">jq -r &#39;include &quot;module-openapi&quot;; oas_operations[0].summary&#39; demo-api-openapi.json
cd ..
jq -r &#39;include &quot;module-openapi&quot;; oas_operations[0].summary&#39; jq-and-openapi/demo-api-openapi.json
jq -r -L jq-and-openapi &#39;include &quot;module-openapi&quot;; oas_operations[0].summary&#39; jq-and-openapi/demo-api-openapi.json

</pre>
  <div class="code-title"><button type="button" class="btn btn-default btn-block">Indicating where to find modules with -L argument</button></div>
  <div class="code-toolbar-for-title">
    <div class="btn-group" role="group" aria-label="...">
      
      <button type="button" class="btn btn-default copy-btn"><i class="fas fa-paste"></i></button>
    </div>
  </div>
  <pre class="language-bash line-numbers"><code>[apihandyman.io]$ jq -r &#39;include &quot;module-openapi&quot;; oas_operations[0].summary&#39; demo-api-openapi.json
List accounts
[apihandyman.io]$ cd ..
[apihandyman.io]$ jq -r &#39;include &quot;module-openapi&quot;; oas_operations[0].summary&#39; jq-and-openapi/demo-api-openapi.json
jq: error: module not found: module-openapi

jq: 1 compile error
[apihandyman.io]$ jq -r -L jq-and-openapi &#39;include &quot;module-openapi&quot;; oas_operations[0].summary&#39; jq-and-openapi/demo-api-openapi.json
List accounts</code></pre>
  
</div>

<p>If there are modules that you use extensively, it would be interesting to put them in a <code>~/.jq</code> folder. Therefore, no longer need for the <code>-L</code> argument as shown below. JQ looks for the modules mentioned in <code>include</code> directives in this folder automatically.</p>

<div>
  <pre class="copy-hidden">mkdir ~/.jq
cp jq-and-openapi/module-openapi.jq ~/.jq
jq -r &#39;include &quot;module-openapi&quot;; oas_operations[0].summary&#39; jq-and-openapi/demo-api-openapi.json

</pre>
  <div class="code-title"><button type="button" class="btn btn-default btn-block">Using ~/.jq default folder to store modules</button></div>
  <div class="code-toolbar-for-title">
    <div class="btn-group" role="group" aria-label="...">
      
      <button type="button" class="btn btn-default copy-btn"><i class="fas fa-paste"></i></button>
    </div>
  </div>
  <pre class="language-bash line-numbers"><code>[apihandyman.io]$ mkdir ~/.jq
[apihandyman.io]$ cp jq-and-openapi/module-openapi.jq ~/.jq
[apihandyman.io]$ jq -r &#39;include &quot;module-openapi&quot;; oas_operations[0].summary&#39; jq-and-openapi/demo-api-openapi.json
List accounts</code></pre>
  
</div>

<p>Note that <code>~/.jq</code> can also be a file. In that case, you don‚Äôt even need to <code>include</code> anything, as shown below. Any function defined in this file is usable inside any of your filters. I personally do not recommend to do this because that makes your filters dependencies invisible (and can also result in a quite huge unmaintainable <code>.jq</code> file).</p>

<div>
  <pre class="copy-hidden">rm -rf ~/.jq
cp jq-and-openapi/module-openapi.jq ~/.jq
jq -r &#39;oas_operations[0].summary&#39; jq-and-openapi/demo-api-openapi.json

</pre>
  <div class="code-title"><button type="button" class="btn btn-default btn-block">Using ~/.jq default file to store functions</button></div>
  <div class="code-toolbar-for-title">
    <div class="btn-group" role="group" aria-label="...">
      
      <button type="button" class="btn btn-default copy-btn"><i class="fas fa-paste"></i></button>
    </div>
  </div>
  <pre class="language-bash line-numbers"><code>[apihandyman.io]$ rm -rf ~/.jq
[apihandyman.io]$ cp jq-and-openapi/module-openapi.jq ~/.jq
[apihandyman.io]$ jq -r &#39;oas_operations[0].summary&#39; jq-and-openapi/demo-api-openapi.json
List accounts</code></pre>
  
</div>

<h1 id="searching-operations-using-command-line-arguments">Searching operations using command line arguments</h1>

<p>Now that we have a reusable module that provides functions to list operations of an OpenAPI specification file and print them as tab separated text, let‚Äôs work on a multiple-criteria and multiple-file search.</p>

<h2 id="passing-an-argument-to-jq-filters">Passing an argument to JQ filters</h2>

<p>In order to make this search flexible, we‚Äôll need to be able to accept search arguments coming from outside our filter in order to avoid having to modify it on each different search. Passing arguments to JQ is done with <code>--arg &lt;name&gt; &lt;value&gt;</code> as shown below. Inside the filter, you can access a <code>--arg</code> with <code>$&lt;name&gt;</code>. In this case <code>$foo</code> returns <code>bar</code>. Note also in this example the <code>-n</code> flag which is used to tell JQ to not expect any JSON input. That‚Äôs pretty useful to make demos of some JQ‚Äôs features but also to generate JSON from scratched based on some arguments values.</p>

<div>
  <pre class="copy-hidden">jq -n --arg foo bar &#39;{foo: $foo}&#39;

</pre>
  <div class="code-title"><button type="button" class="btn btn-default btn-block">Passing an argument with --arg (and discovering -n flag)</button></div>
  <div class="code-toolbar-for-title">
    <div class="btn-group" role="group" aria-label="...">
      
      <button type="button" class="btn btn-default copy-btn"><i class="fas fa-paste"></i></button>
    </div>
  </div>
  <pre class="language-bash line-numbers"><code>[apihandyman.io]$ jq -n --arg foo bar &#39;{foo: $foo}&#39;
{
  &quot;foo&quot;: &quot;bar&quot;
}</code></pre>
  
</div>

<h2 id="searching-operations-accessible-for-a-scope">Searching operations accessible for a scope</h2>

<p>The following listing shows which operations are accessible to a consumer when it is given the <code>transfer:admin</code> security scope. The scope value is provided to the filter using <code>--arg &lt;name&gt; &lt;value&gt;</code>.</p>

<div>
  <pre class="copy-hidden">jq -r --arg scope transfer:admin -f search-operations-using-scope.jq demo-api-openapi.json 

</pre>
  <div class="code-title"><button type="button" class="btn btn-default btn-block">Searching operations using a given scope</button></div>
  <div class="code-toolbar-for-title">
    <div class="btn-group" role="group" aria-label="...">
      
      <button type="button" class="btn btn-default copy-btn"><i class="fas fa-paste"></i></button>
    </div>
  </div>
  <pre class="language-bash line-numbers"><code>[apihandyman.io]$ jq -r --arg scope transfer:admin -f search-operations-using-scope.jq demo-api-openapi.json 
post    /transfers      Transfer money
get     /transfers      List money transfers
get     /transfers/{id} Get a money transfer
delete  /transfers/{id} Cancel a money transfer</code></pre>
  
</div>

<p>In an OpenAPI file, you‚Äôll find the scopes that will grant access to an operation in its security property under a <code>{name}</code>.
According the OpenAPI Specification, <em>each name MUST correspond to a security scheme which is declared in the Security Schemes under the Components Object. If the security scheme is of type ‚Äúoauth2‚Äù or ‚ÄúopenIdConnect‚Äù, then the value is a list of scope names required for the execution. For other security scheme types, the array MUST be empty</em>.</p>

<div>
      <img src="/images/api-toolbox-jq-and-openapi-part-2-using-jq-command-line-arguments-functions-and-modules/jq-openapi-scopes.png" />
      
    </div>

<p>For our use case, we just need to list all values (scopes) under all <code>security.{name}</code> of each operation and keep the operations for which the provided scope is found in this list. The following listing shows how this is achieved in the <code>search-operations-using-scope.jq</code>.</p>

<ul>
  <li>First (line 4), it lists existing operations using the <code>oas_operations</code> function (coming from <code>module-openapi</code> included on line 1)</li>
  <li>Then (line 5), it filters the returned operations based on their scopes by working on each of the <code>original</code> operation‚Äôs data coming from the OpenAPI file. To do so:
    <ul>
      <li>It first checks if there‚Äôs a <code>security</code> property (line 7)</li>
      <li>Then creates a list of scopes (line 9 and 10)</li>
      <li>And (line 11 to 14), if the <code>index</code> of <code>$scope</code> (provided through the <code>--arg scope &lt;value&gt;</code>) is greater than 0 (meaning it is in the list), the operation is returned</li>
    </ul>
  </li>
  <li>And finally (line 19), it prints the remaining operations as tab separated values using the <code>oas_operations_to_text</code> function (coming from <code>module-openapi</code> included on line 1)</li>
</ul>

<div>
  <!-- codeblocksize: 20 -->
  <div class="code-title"><button type="button" class="btn btn-default btn-block">search-operations-using-scope.jq</button></div>
  <div class="code-toolbar-for-title">
    <div class="btn-group" role="group" aria-label="...">
        
        <button type="button" class="btn btn-default"><a target="_blank" href="/code/api-toolbox-jq-and-openapi/part-2/search-operations-using-scope.jq"><i class="fas fa-file-code"></i></a></button>
        <button type="button" class="btn btn-default btn-copy"><i class="fas fa-paste"></i></button>
    </div>
  </div>
  <pre class="language-jq line-numbers"><code>include "module-openapi"; # Looks for a module-openapi.jq file

# Expects a --arg scope value parameter
oas_operations # Comes from module-operations.jq
| map(select( # Filters on operation scopes
    # security is not always present
    if .original.security? != null then
      # Creating an array containg all scopes
      [ .original.security | 
        map(to_entries | map(.value)[])[][] ] | 
      index( # Index returns the index of a value in array
        $scope # $scope value is provided on the command line
              # --arg scope value
      ) &#62;= 0 # If &#60; 0, it has not been found
    else
      false # No security defined, so return false
    end
  ))
| oas_operations_to_text  # Comes from module-operations.jq</code></pre>
  
</div>

<p>That‚Äôs cool, but there‚Äôs a little problem. When using the <code>search-operations-using-scope.jq</code> without providing the scope value, it does not work: JQ complains that <code>$scope</code> is not defined, as shown below.</p>

<div>
  <pre class="copy-hidden">jq -r -f search-operations-using-scope.jq demo-api-openapi.json

</pre>
  <div class="code-title"><button type="button" class="btn btn-default btn-block">What happens when scope is not provided</button></div>
  <div class="code-toolbar-for-title">
    <div class="btn-group" role="group" aria-label="...">
      
      <button type="button" class="btn btn-default copy-btn"><i class="fas fa-paste"></i></button>
    </div>
  </div>
  <pre class="language-bash line-numbers"><code>[apihandyman.io]$ jq -r -f search-operations-using-scope.jq demo-api-openapi.json
jq: error: $scope is not defined at &lt;top-level&gt;, line 12:
        $scope # $scope value is provided on the command line        
jq: 1 compile error</code></pre>
  
</div>

<p>Does that mean we can‚Äôt do a multi-criteria search because it requires to be able to provide multiple <em>optional</em> parameters? Of course not, that problem can be solved.</p>

<h2 id="solving-the-command-line-argument-problem">Solving the command line argument ‚Äúproblem‚Äù</h2>

<asciinema-player poster="npt:1:20" title="Solving the command line argument problem" author="Arnaud Lauret" rows="24" cols="80" src="/code/api-toolbox-jq-and-openapi/part-2/solving-argument-problem.cast"></asciinema-player>

<p>The following listing shows how to safely access a command line named argument using the <code>$ARGS.named</code> filter. If <code>$name</code> causes an error if no <code>--arg name value</code> is provided on the command line, <code>$ARGS.named['name']</code> will return <code>null</code> without causing any.</p>

<div>
  <pre class="copy-hidden">jq -n --arg foo hello --arg bar world &#39;{foo: $foo, bar: $bar}&#39;
jq -n --arg foo hello &#39;{foo: $foo, bar: $bar}&#39;
jq -n --arg foo hello &#39;{foo: $ARGS.named[&quot;foo&quot;], bar: $ARGS.named[&quot;bar&quot;]}&#39;

</pre>
  <div class="code-title"><button type="button" class="btn btn-default btn-block">Using $ARGS.named</button></div>
  <div class="code-toolbar-for-title">
    <div class="btn-group" role="group" aria-label="...">
      
      <button type="button" class="btn btn-default copy-btn"><i class="fas fa-paste"></i></button>
    </div>
  </div>
  <pre class="language-bash line-numbers"><code>[apihandyman.io]$ jq -n --arg foo hello --arg bar world &#39;{foo: $foo, bar: $bar}&#39;
{
  &quot;foo&quot;: &quot;hello&quot;,
  &quot;bar&quot;: &quot;world&quot;
}
[apihandyman.io]$ jq -n --arg foo hello &#39;{foo: $foo, bar: $bar}&#39;
jq: error: $bar is not defined at &lt;top-level&gt;, line 1:
{foo: $foo, bar: $bar}                 
jq: 1 compile error
[apihandyman.io]$ jq -n --arg foo hello &#39;{foo: $ARGS.named[&quot;foo&quot;], bar: $ARGS.named[&quot;bar&quot;]}&#39;
{
  &quot;foo&quot;: &quot;hello&quot;,
  &quot;bar&quot;: null
}</code></pre>
  
</div>

<p>That‚Äôs very handy, but what if I want to set an argument to a default value if it is not provided? I just need to use the following <code>module-args</code> module. It defines a <code>init_parameter(default_values)</code> function returning an object containing parameters set to the value coming from <code>--arg &lt;name&gt;</code> or a default value it is not provided. To do so, for each entry (key/value) of a <code>default_values</code> object parameter, it checks if the named arguments (<code>$ARGS.named</code>) contains the key and if so, sets the output value to the one provided on the command line. If not, it keeps the default one. By the way, that means that JQ functions can also use parameters besides their regular input. But note that you don‚Äôt need to prefix their name by <code>$</code> to access them.</p>

<div>
  <!-- codeblocksize: 20 -->
  <div class="code-title"><button type="button" class="btn btn-default btn-block">module-args.jq</button></div>
  <div class="code-toolbar-for-title">
    <div class="btn-group" role="group" aria-label="...">
        
        <button type="button" class="btn btn-default"><a target="_blank" href="/code/api-toolbox-jq-and-openapi/part-2/module-args.jq"><i class="fas fa-file-code"></i></a></button>
        <button type="button" class="btn btn-default btn-copy"><i class="fas fa-paste"></i></button>
    </div>
  </div>
  <pre class="language-jq line-numbers"><code># Initializes parameters based on provided named arguments (--arg).
# If an argument is not provided, its default value is used.
# default_values example:
# {
#   argument: "default value",
#   anotherArgument: null,
# }
def init_parameters(default_values):
  default_values | 
  # Updates values for provided parameters
  with_entries(
    # $ARGS contains all --arg parameters
    if $ARGS.named[.key] != null then 
      .value = $ARGS.named[.key] 
    else 
      .value = .value
    end
  )
;</code></pre>
  
</div>

<p>The following listing shows how this function can be used. Just call the <code>init_parameter</code> function with an object containing the default values and put its result in a variable (here <code>$parameter</code>) for later use (<code>$parameter.foo</code> for example). Here the default value of <code>foo</code> is <code>default foo</code> and <code>bar</code>‚Äôs is <code>null</code>. Only <code>bar</code> is provided, so the output contains <code>foo</code>‚Äôs default value and <code>bar</code> command-line-provided value.</p>

<div>
  <pre class="copy-hidden">jq -n --arg bar &quot;bar from command line&quot; &#39;include &quot;module-args&quot;; init_parameters({foo: &quot;default foo&quot;, bar: null}) as $parameters| {foo: $parameters.foo, bar: $parameters.bar}&#39;

</pre>
  <div class="code-title"><button type="button" class="btn btn-default btn-block">Optional parameters with default values</button></div>
  <div class="code-toolbar-for-title">
    <div class="btn-group" role="group" aria-label="...">
      
      <button type="button" class="btn btn-default copy-btn"><i class="fas fa-paste"></i></button>
    </div>
  </div>
  <pre class="language-bash line-numbers"><code>[apihandyman.io]$ jq -n --arg bar &quot;bar from command line&quot; &#39;include &quot;module-args&quot;; init_parameters({foo: &quot;default foo&quot;, bar: null}) as $parameters| {foo: $parameters.foo, bar: $parameters.bar}&#39;
{
  &quot;foo&quot;: &quot;default foo&quot;,
  &quot;bar&quot;: &quot;bar from command line&quot;
}</code></pre>
  
</div>

<h2 id="searching-operations-on-multiple-criteria-and-multiple-files">Searching operations on multiple criteria and multiple files</h2>

<asciinema-player poster="npt:1:20" title="Searching operations demo" author="Arnaud Lauret" rows="24" cols="80" src="/code/api-toolbox-jq-and-openapi/part-2/search-demo.cast"></asciinema-player>

<p>Now that we know how to provide multiple optional parameters, let‚Äôs do a multi-criteria search. The following listing shows the <code>get</code> operations on paths containing <code>sources</code> across all available <code>*.json</code> files. The first value on each line is the filename (limited to 20 characters).</p>

<div>
  <pre class="copy-hidden">jq --arg path_contains sources --arg method get -r -f search-operations.jq *.json

</pre>
  <div class="code-title"><button type="button" class="btn btn-default btn-block">Operations on path containing source with method get</button></div>
  <div class="code-toolbar-for-title">
    <div class="btn-group" role="group" aria-label="...">
      
      <button type="button" class="btn btn-default copy-btn"><i class="fas fa-paste"></i></button>
    </div>
  </div>
  <pre class="language-bash line-numbers"><code>[apihandyman.io]$ jq --arg path_contains sources --arg method get -r -f search-operations.jq *.json
[demo-another-api-swa]  get     /resources
[demo-api-openapi.jso]  get     /sources        List transfer sources
[demo-api-openapi.jso]  get     /sources/{id}/destinations      List transfer source&#39;s destinations</code></pre>
  
</div>

<p>Here‚Äôs the <code>search-operations.jq</code> file who does that. It reuses functions we have seen before, <code>oas_operations</code> from the <code>module_openapi.jq</code> file and <code>init_parameters</code> from the <code>module-args.jq</code> file. It also uses new functions <code>filter_operations</code>, <code>default_filters</code>, <code>print_oas_operations</code> and <code>default_print_parameters</code> from <code>module-openapi-search.jq</code>. There are 3 steps: getting operations data, filtering them and finally printing them. There‚Äôs nothing new on the first step, we already have used this function. Let‚Äôs see what is happening on the second and after that the third step.</p>

<div>
  <!-- codeblocksize: 20 -->
  <div class="code-title"><button type="button" class="btn btn-default btn-block">search-operations.jq</button></div>
  <div class="code-toolbar-for-title">
    <div class="btn-group" role="group" aria-label="...">
        
        <button type="button" class="btn btn-default"><a target="_blank" href="/code/api-toolbox-jq-and-openapi/part-2/search-operations.jq"><i class="fas fa-file-code"></i></a></button>
        <button type="button" class="btn btn-default btn-copy"><i class="fas fa-paste"></i></button>
    </div>
  </div>
  <pre class="language-jq line-numbers"><code>include "module-openapi";
include "module-args";
include "module-openapi-search";

# Gets operations data
oas_operations
# Filters operations
| filter_oas_operations(init_parameters(default_filters))
# Prints operations
| print_oas_operations(init_parameters(default_print_parameters).format)</code></pre>
  
</div>

<p>The following listing shows the new functions used to filter operations. The <code>default_filters</code> only returns the search filters default value to be used in conjunction with <code>init_parameters</code> and so get cleans values from optional command line arguments. The <code>filter_oas_operation</code> expects a <code>filter</code> object whose structure is the same as the one returned by default filters. This operations runs a <code>map(select())</code> on the operations list. Each filter is triggered if <code>filters.&lt;name&gt;</code> is not null. There‚Äôs nothing really new regarding JQ‚Äôs filters besides line 41. The filtering on paths is done using the <code>contains</code> filter which we hadn‚Äôt seen before.</p>

<div>
  <!-- codeblocksize: 20 -->
  <div class="code-title"><button type="button" class="btn btn-default btn-block">Filtering operations (module-openapi-search.jq)</button></div>
  <div class="code-toolbar-for-title">
    <div class="btn-group" role="group" aria-label="...">
        <button type="button" class="btn btn-default" onclick="toggle(this, this.parentElement.parentElement.parentElement.children[2], this.parentElement.parentElement.parentElement.children[3].children[0])"><i class="fa fa-expand" aria-hidden="true"></i></button>
        <button type="button" class="btn btn-default"><a target="_blank" href="/code/api-toolbox-jq-and-openapi/part-2/module-openapi-search.jq"><i class="fas fa-file-code"></i></a></button>
        <button type="button" class="btn btn-default btn-copy"><i class="fas fa-paste"></i></button>
    </div>
  </div>
  <pre class="language-jq line-numbers code-collapsed" data-start="3"><code># Available filters and their default values
# To be used with init_parameters
def default_filters:
{
  deprecated: null,
  method: null,
  code: null,
  scope: null,
  path_contains: null
};

# Filters operations coming from oas_operations
# Each filter is used only if corresponding filters.&#60;name&#62; parameter is provided
def filter_oas_operations(filters):
  map(
    select(
    # Filters on deprecated
    (filters.deprecated == null or 
      (.deprecated | tostring) == filters.deprecated) and
    # Filters on HTTP method
    (filters.method == null or 
      .method == filters.method) and
    # Filters on HTTP status code
    (filters.code == null or 
      (.original.responses | has(filters.code))) and
    # Filters on security scope
    (filters.scope == null or
      (if .value.security? != null then
        [ .value.security | 
          map(to_entries | 
          map(.value)[])[][]] | 
        index(filters.scope) &#62;= 0
      else
        false
      end)
    ) and
    # Filters on path
    (filters.path_contains == null or 
      (.path | contains(filters.path_contains))
    )
  )
);
</code></pre>
  <div class="code-bottom-toolbar"><button type="button" class="btn btn-default btn-block" onclick="toggle(this, this.parentElement.parentElement.children[2], this.parentElement.parentElement.children[1].children[0].children[0], true)"><i class="fa fa-expand" aria-hidden="true"></i></button></div>
</div>

<p>The following listing shows the new functions used to print the operations. It uses the same mechanism as the filter functions regarding the command line arguments.</p>

<div>
  <!-- codeblocksize: 20 -->
  <div class="code-title"><button type="button" class="btn btn-default btn-block">Printing operations (module-openapi-search.jq)</button></div>
  <div class="code-toolbar-for-title">
    <div class="btn-group" role="group" aria-label="...">
        <button type="button" class="btn btn-default" onclick="toggle(this, this.parentElement.parentElement.parentElement.children[2], this.parentElement.parentElement.parentElement.children[3].children[0])"><i class="fa fa-expand" aria-hidden="true"></i></button>
        <button type="button" class="btn btn-default"><a target="_blank" href="/code/api-toolbox-jq-and-openapi/part-2/module-openapi-search.jq"><i class="fas fa-file-code"></i></a></button>
        <button type="button" class="btn btn-default btn-copy"><i class="fas fa-paste"></i></button>
    </div>
  </div>
  <pre class="language-jq line-numbers code-collapsed" data-start="46"><code># Same as oas_operations_to_text but with source
def oas_operations_to_text_with_source: 
  map( # Applies a transformation to each element
    "[" + .source[0:20] + "]\t" +
    .method + "\t" + 
    .path + "\t" + 
    .summary + 
    (if .deprecated then " (deprecated)" else "" end)
  )
  [] # Flattens array for raw output
; # oas_operations_to_text function's end

# To be used with init_parameters
def default_print_parameters:
{
  format: "text_with_source"
  # All values: 
  #  text_with_source, text_without_source, json_flat or null for json
};

# Prints oas_operations (filtered or not) in various format
def print_oas_operations(format):
  if format == "text_with_source" then
      oas_operations_to_text_with_source
  elif format == "text_without_source" then
      oas_operations_to_text
  elif format == "json_flat" then
    .[] # Flattening for multifiles, pipe result into a jq -s
  else
    .
  end
;
</code></pre>
  <div class="code-bottom-toolbar"><button type="button" class="btn btn-default btn-block" onclick="toggle(this, this.parentElement.parentElement.children[2], this.parentElement.parentElement.children[1].children[0].children[0], true)"><i class="fa fa-expand" aria-hidden="true"></i></button></div>
</div>

<p>Here‚Äôs the full file:</p>

<div>
  <!-- codeblocksize: 20 -->
  <div class="code-title"><button type="button" class="btn btn-default btn-block">Filtering operations (module-openapi-search.jq)</button></div>
  <div class="code-toolbar-for-title">
    <div class="btn-group" role="group" aria-label="...">
        <button type="button" class="btn btn-default" onclick="toggle(this, this.parentElement.parentElement.parentElement.children[2], this.parentElement.parentElement.parentElement.children[3].children[0])"><i class="fa fa-expand" aria-hidden="true"></i></button>
        <button type="button" class="btn btn-default"><a target="_blank" href="/code/api-toolbox-jq-and-openapi/part-2/module-openapi-search.jq"><i class="fas fa-file-code"></i></a></button>
        <button type="button" class="btn btn-default btn-copy"><i class="fas fa-paste"></i></button>
    </div>
  </div>
  <pre class="language-jq line-numbers code-collapsed"><code>include "module-openapi";

# Available filters and their default values
# To be used with init_parameters
def default_filters:
{
  deprecated: null,
  method: null,
  code: null,
  scope: null,
  path_contains: null
};

# Filters operations coming from oas_operations
# Each filter is used only if corresponding filters.&#60;name&#62; parameter is provided
def filter_oas_operations(filters):
  map(
    select(
    # Filters on deprecated
    (filters.deprecated == null or 
      (.deprecated | tostring) == filters.deprecated) and
    # Filters on HTTP method
    (filters.method == null or 
      .method == filters.method) and
    # Filters on HTTP status code
    (filters.code == null or 
      (.original.responses | has(filters.code))) and
    # Filters on security scope
    (filters.scope == null or
      (if .value.security? != null then
        [ .value.security | 
          map(to_entries | 
          map(.value)[])[][]] | 
        index(filters.scope) &#62;= 0
      else
        false
      end)
    ) and
    # Filters on path
    (filters.path_contains == null or 
      (.path | contains(filters.path_contains))
    )
  )
);

# Same as oas_operations_to_text but with source
def oas_operations_to_text_with_source: 
  map( # Applies a transformation to each element
    "[" + .source[0:20] + "]\t" +
    .method + "\t" + 
    .path + "\t" + 
    .summary + 
    (if .deprecated then " (deprecated)" else "" end)
  )
  [] # Flattens array for raw output
; # oas_operations_to_text function's end

# To be used with init_parameters
def default_print_parameters:
{
  format: "text_with_source"
  # All values: 
  #  text_with_source, text_without_source, json_flat or null for json
};

# Prints oas_operations (filtered or not) in various format
def print_oas_operations(format):
  if format == "text_with_source" then
      oas_operations_to_text_with_source
  elif format == "text_without_source" then
      oas_operations_to_text
  elif format == "json_flat" then
    .[] # Flattening for multifiles, pipe result into a jq -s
  else
    .
  end
;

</code></pre>
  <div class="code-bottom-toolbar"><button type="button" class="btn btn-default btn-block" onclick="toggle(this, this.parentElement.parentElement.children[2], this.parentElement.parentElement.children[1].children[0].children[0], true)"><i class="fa fa-expand" aria-hidden="true"></i></button></div>
</div>

<h1 id="summary">Summary</h1>

<p>That concludes this second path of the JQ and OpenAPI series. Here‚Äôs the summary of what we have seen in this post:</p>

<h2 id="functions-and-modules">Functions and modules</h2>

<ul>
  <li>Creating a function is done with <code>def name: &lt;filters&gt;;</code></li>
  <li>To invoke a function just use its <code>name</code> like for any regular filter</li>
  <li>Functions can have parameters <code>def name(parameter)</code></li>
  <li>Inside a function a parameter can be used with <code>parameter</code> (without $)</li>
  <li>A module is a JQ file containing reusable functions</li>
  <li>A module is loaded using the <code>include filename_without_extension</code> directive</li>
  <li>Use <code>-L</code> command line parameter to tell JQ where to find modules</li>
  <li>Put your favorite modules in <code>~/.jq</code> folder so JQ can find them without using <code>-L</code></li>
</ul>

<h2 id="command-line-arguments">Command line arguments</h2>

<ul>
  <li>Passing a named argument to JQ filters is done with <code>--arg name value</code></li>
  <li>A named argument value can be retrieved with <code>$name</code></li>
  <li>Using <code>$name</code> will provoke an error if no <code>--arg name value</code> is provided</li>
  <li>All named arguments are available with <code>$ARGS.named</code></li>
  <li><code>$ARGS.named[name]</code> returns null (wihout error) if no <code>--arg name value</code> is provided</li>
</ul>

<h2 id="the-null-argument">The null argument</h2>

<ul>
  <li>The <code>-n</code> (<code>--null</code>) arguments tells JQ to not expect input JSON</li>
</ul>

<h2 id="new-filters">New filters</h2>

<table class="table table-sm">
  <thead>
    <tr>
      <th span="3">JQ Filters</th>
    </tr>
  </thead>
  <tbody>



    <tr>
      <td><code>index(element)</code></td>
      <td>Returns the index of an element inside an array (-1 if not found)</td>
      <td><a href="https://stedolan.github.io/jq/manual/v1.6/#index(s),rindex(s)" target="jq"><i class="fas fa-external-link-alt"></i></a></td>
    </tr>


    <tr>
      <td><code>contains(element)</code><br /><code>"resources" | contains("source")
</code></td>
      <td>Returns true the element is in input</td>
      <td><a href="https://stedolan.github.io/jq/manual/v1.6/#contains(element)" target="jq"><i class="fas fa-external-link-alt"></i></a></td>
    </tr>


    <tr>
      <td><code>$ARGS.named</code></td>
      <td>Returns the command line named argument (--arg name value)</td>
      <td><a href="https://stedolan.github.io/jq/manual/v1.6/#Invokingjq" target="jq"><i class="fas fa-external-link-alt"></i></a></td>
    </tr>

  </tbody>
</table>

<h1 id="whats-next">What‚Äôs next</h1>

<p>In next post, we‚Äôll learn to modify OpenAPI files with JQ.</p>

      
  <div id="disqus_thread"></div>
  <script>
    var disqus_config = function () {
      this.page.url = 'https://apihandyman.io/api-toolbox-jq-and-openapi-part-2-using-jq-command-line-arguments-functions-and-modules/';
      this.page.identifier = 'https://apihandyman.io/api-toolbox-jq-and-openapi-part-2-using-jq-command-line-arguments-functions-and-modules/';
    };

    (function() {
      var d = document, s = d.createElement('script');

      s.src = 'https://apihandyman.disqus.com/embed.js';

      s.setAttribute('data-timestamp', +new Date());
      (d.head || d.body).appendChild(s);
    })();
  </script>
  <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>


    </div>
  </article>
</div>
<div class="hidden-xs col-sm-2 col-md-2" role="complementary">
  <nav id="toc" data-spy="affix" data-offset-top="400"></nav>
</div>
          </main>
        </div>
      </div>
      <div class="container">
        <div class="row">
          <div class="col-xs-12 col-md-12">
            <footer>
  <nav class="navbar navbar-fixed-bottom">
    <ul class="list-inline">
     <li>
       <a href="/feed.xml"><i class="fa fa-rss-square fa-2x" aria-hidden="true"></i></a>
     </li>
     <li>
      <a href="https://twitter.com/apihandyman"><i class="fab fa-twitter-square fa-2x"></i></a>   
     </li>
     <li>
      <a href="https://github.com/arno-di-loreto"><i class="fab fa-github-square fa-2x"></i></a>   
     </li>
     <li>
      <a href="https://www.linkedin.com/in/arnaudlauret"><i class="fab fa-linkedin fa-2x"></i></a>   
     </li>
    </ul>
  </nav>
</footer>
          </div>
        </div>
      </div>
        <script type="text/javascript" src="/js/jquery.min.js" ></script>
  <script type="text/javascript" src="/js/bootstrap.min.js" ></script>
  <script type="text/javascript" src="/js/asciinema-player.js"></script>
  
    <script type="text/javascript" src="/js/bootstrap-toc.min.js" ></script>
<script language="javascript">
  $(function() {
    var $myNav = $('#toc');
    var $myScope = $('#post');
    Toc.init({
      $nav: $myNav,
      $scope: $myScope
    });
    $('body').scrollspy({
      target: '#toc'
    });
  });
</script>
<script type="text/javascript" src="/js/anchor.min.js" ></script>
<script language="JavaScript">
  $(function() {
    anchors.options = {
      placement: 'left'
    };
    anchors.add('.blog-container h1');
    anchors.add('.blog-container h2');
    anchors.add('.blog-container h3');
  });
</script>
<script type="text/javascript" src="/js/prism.js" ></script>
<script type="text/javascript" src="/js/clipboard.min.js" ></script>
<script language="JavaScript">

  var clipboard = new ClipboardJS('.copy-btn', {
      target: function(trigger) {
        console.log(trigger.parentElement.parentElement.parentElement.children[0]);
        return trigger.parentElement.parentElement.parentElement.children[0];
      }
  });

  clipboard.on('success', function(e) {
    e.clearSelection();
    $(e.trigger).html('<i class="fa fa-check"></i>');
    window.setTimeout(function() {
        $(e.trigger).html('<i class="fas fa-paste"></i>');
        $(e.trigger).blur();
    }, 1000);
  });

  clipboard.on('error', function(e) {
    console.error('Action:', e.action);
    console.error('Trigger:', e.trigger);
  });
</script>
<script language="JavaScript">
  function toggle(button, code, secondarybutton, scroll) {
    var beforecodeheight = $(code).height(); 
    if($(code).hasClass('code-collapsed')) {
      $(code).removeClass('code-collapsed');
      $(button).html('<i class="fa fa-compress"></i>');
      $(secondarybutton).html('<i class="fa fa-compress"></i>');
      $(button).blur();
    }
    else {
      $(code).addClass('code-collapsed');
      $(button).html('<i class="fa fa-expand"></i>');
      $(secondarybutton).html('<i class="fa fa-expand"></i>');
      $(button).blur();
      if(scroll) {
        var aftercodeheight = $(code).height();
        var afterscroll = $('body').scrollTop();
        var delta = beforecodeheight - aftercodeheight;
        $('body').scrollTop(afterscroll - delta);
      }
    }
  }
</script>
  
  </body>

</html>